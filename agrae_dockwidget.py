# -*- coding: utf-8 -*-
"""
/***************************************************************************
agraeDockWidget
                                 A QGIS plugin
 Conjunto de herramientas
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                             -------------------
        begin                : 2021-12-03
        git sha              : $Format:%H$
        copyright            : (C) 2021 by  aGrae Solutions, S.L.
        email                : info@agrae.es
 ***************************************************************************/
/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""

import os
# from datetime import date

from psycopg2 import OperationalError,InterfaceError, errors, extras
from PyQt5.QtCore import QRegExp, QDate, Qt
from PyQt5.QtGui import QRegExpValidator, QIcon, QPixmap
from PyQt5.QtWidgets import *
from qgis.PyQt import QtGui, QtWidgets, uic
from qgis.PyQt.QtCore import pyqtSignal, QSettings
from qgis.core import *
from qgis.utils import iface
from .agrae_dialogs import agraeSegmentoDialog
from .utils import AgraeUtils, AgraeToolset

from .agraeTools import agraeToolset
from .resources import *




agraeSidePanel, _ = uic.loadUiType(os.path.join(os.path.dirname(__file__), 'ui/agrae_dockwidget_base.ui'))
agraeConfigPanel, _ = uic.loadUiType(os.path.join(os.path.dirname(__file__), 'ui/config_ui.ui'))
agraeMainPanel, _ = uic.loadUiType(os.path.join(os.path.dirname(__file__), 'ui/agrae_main.ui'))
agraeParcelaDialog, _ = uic.loadUiType(os.path.join(os.path.dirname(__file__), 'ui/dialogs/parcela_dialog.ui'))

agraeLoteDialog, _ = uic.loadUiType(os.path.join(os.path.dirname(__file__), 'ui/dialogs/lote_dialog.ui'))
agraeLoteParcelaDialog, _ = uic.loadUiType(os.path.join(os.path.dirname(__file__), 'ui/dialogs/loteparcela_dialog.ui'))
agraeExpDialog, _ = uic.loadUiType(os.path.join(os.path.dirname(__file__), 'ui/dialogs/exp_dialog.ui'))
agraeCultivoDialog, _ = uic.loadUiType(os.path.join(os.path.dirname(__file__), 'ui/dialogs/cultivo_dialog.ui'))

class agraeDockWidget(QtWidgets.QDockWidget, agraeSidePanel):
    closingPlugin = pyqtSignal()
    def __init__(self, parent=None):
        """Constructor."""
        super(agraeDockWidget, self).__init__(parent)
        # Set up the user interface from Designer.
        # After setupUI you can access any designer object by doing
        # self.<objectname>, and you can use autoconnect slots - see
        # http://doc.qt.io/qt-5/designer-using-a-ui-file.html
        # #widgets-and-dialogs-with-auto-connect
        self.setupUi(self)
        self.pushButton.clicked.connect(self.select_input_file)

    def select_input_file(self):
        filename = QFileDialog.getOpenFileName(None,'Seleccionar archivo')
        # print(filename[0])
        self.lineEdit.setText(filename[0])
        print(len(self.lineEdit.text()))
    def closeEvent(self, event):
        self.closingPlugin.emit()
        event.accept()


class agraeConfigWidget(QtWidgets.QDialog, agraeConfigPanel): 
    closingPlugin2 = pyqtSignal()
    def __init__(self, parent=None):
        """Constructor."""
        super(agraeConfigWidget, self).__init__(parent)
        self.s = QSettings('agrae','dbhost')
        # Set up the user interface from Designer.
        # After setupUI you can access any designer object by doing
        # self.<objectname>, and you can use autoconnect slots - see
        # http://doc.qt.io/qt-5/designer-using-a-ui-file.html
        # #widgets-and-dialogs-with-auto-connect
        self.setupUi(self)      
    
    def closeEvent(self, event):  
        self.closingPlugin2.emit()
        event.accept()

class parcelaFindDialog(QtWidgets.QDialog, agraeParcelaDialog):
    closingPlugin = pyqtSignal()

    actualizar = pyqtSignal(list)
    actualizarRel = pyqtSignal(str) 
    sqlSignal = pyqtSignal(str)

    def __init__(self, parent=None):
        """Constructor."""
        super(parcelaFindDialog, self).__init__(parent)
        self.utils = AgraeUtils()
        self.conn = self.utils.Conn()

        


        data = self.dataAuto()
        lista = [e[0] for e in data]
        completer = QCompleter(lista)
        completer.setCaseSensitivity(False)
        self.setupUi(self)
        self.btn_buscar.clicked.connect(self.buscar)
        self.lineEdit.setCompleter(completer)       
        self.tableWidget.horizontalHeader().setStretchLastSection(True)
        self.pushButton.clicked.connect(self.cargarParcela)
        self.pushButton_2.clicked.connect(self.insertarIdRelacion)



    def closeEvent(self, event):

        self.closingPlugin.emit()

        event.accept()


    def data(self, filtro=None):
        if filtro == None:
            cursor = self.conn.cursor()
            sql = '''select p.idparcela, p.nombre parcela, (case when lp2.parcela >= 1 then 'Si' else 'No' end) relacion ,l.nombre lote , cu.nombre cultivo , 
            ca.fechasiembra, ca.fechacosecha ,prov.nombre , mcpo.nombre 
            from parcela p
            left join loteparcela lp on lp.idparcela = p.idparcela 
            left join lotecampania lc on lc.idlotecampania =lp.idlotecampania 
            left join lote l on l.idlote = lc.idlote 
            left join (select lp.idparcela, count(*) as parcela from loteparcela as lp group by lp.idparcela) as lp2  on lp2.idparcela = p.idparcela
            left join campania ca on ca.idcampania = lc.idcampania 
            left join cultivo cu on cu.idcultivo = ca.idcultivo 
            join datos.provincia prov on prov.idprovincia = p.provincia 
            join datos.municipio mcpo on p.municipio = mcpo.idmunicipio '''
            cursor.execute(sql)
            data = cursor.fetchall()
        else:
            cursor = self.conn.cursor()
            sql = f""" select p.idparcela, p.nombre parcela, (case when lp2.parcela >= 1 then 'Si' else 'No' end) relacion ,l.nombre lote , cu.nombre cultivo , 
            ca.fechasiembra, ca.fechacosecha ,prov.nombre , mcpo.nombre 
            from parcela p
            left join loteparcela lp on lp.idparcela = p.idparcela 
            left join lotecampania lc on lc.idlotecampania =lp.idlotecampania 
            left join lote l on l.idlote = lc.idlote 
            left join (select lp.idparcela, count(*) as parcela from loteparcela as lp group by lp.idparcela) as lp2  on lp2.idparcela = p.idparcela
            left join campania ca on ca.idcampania = lc.idcampania 
            left join cultivo cu on cu.idcultivo = ca.idcultivo 
            join datos.provincia prov on prov.idprovincia = p.provincia 
            join datos.municipio mcpo on p.municipio = mcpo.idmunicipio 
            where p.nombre ilike '%{filtro}%' or l.nombre ilike '%{filtro}%' or prov.nombre ilike '%{filtro}%' or mcpo.nombre ilike '%{filtro}%' order by l.idlote """          
            # or p.agregado ilike '%{filtro}%' or p.zona ilike '%{filtro}%' or p.poligono ilike '%{filtro}%' or p.parcela ilike '%{filtro}%' or p.recinto ilike '%{filtro}%' order by p.idparcela """
            cursor.execute(sql)
            data = cursor.fetchall()
        if len(data) >= 1:
            return data
        elif len(data) == 0:
            data = [0, 0]
            return data

    def dataAuto(self):
        cursor = self.conn.cursor()
        sql = "select distinct unnest(array[p.nombre, prov.nombre, mcpo.nombre]) from parcela p left join datos.provincia prov on p.provincia = prov.idprovincia left join datos.municipio mcpo on p.municipio = mcpo.idmunicipio "     
        cursor.execute(sql)
        data = cursor.fetchall()
        return data
    def populate(self,data):
        try:
            a = len(data)
            b = len(data[0])
            i = 1
            j = 1
            self.tableWidget.setRowCount(a)
            self.tableWidget.setColumnCount(b)
            for j in range(a):
                for i in range(b):
                    item = QTableWidgetItem(str(data[j][i]).upper())
                    self.tableWidget.setItem(j, i, item)                 
        except:
            QMessageBox.about(self, "Error:", "No Existen Registros")
            print('error')

    def loadData(self,param=None):    
        if param == None:  
            data = self.data()
            self.populate(data)
        else:
            data = self.data(param)
            self.populate(data)
        pass
    def buscar(self):
        filtro = self.lineEdit.text()
        self.loadData(filtro)
        pass
    def cargarParcela(self):
        # value = self.tableWidget.item(0, 1).text()
        # print(str(value))
        try:
            row = self.tableWidget.currentRow()
            # column = self.tableWidget.currentColumn()
            param = self.tableWidget.item(row, 0).text()
            sqlQuery = f"""select * from parcela where idparcela = {param} """
            conn = self.conn
            cursor = conn.cursor()
            cursor.execute(sqlQuery)
            data = cursor.fetchone()
            dataLista = list(data)
            self.actualizar.emit(dataLista)
            self.sqlSignal.emit(sqlQuery)
            self.close()
          
        except Exception as ex:

            QMessageBox.about(self,'aGrae GIS', 'Debe Seleccionar una parcela para agregar') 
        pass
    def insertarIdRelacion(self):
        try:
            row = self.tableWidget.currentRow()
            idRel = self.tableWidget.item(row, 0).text()
            self.actualizarRel.emit(idRel)
            self.close()
        except Exception as ex:
            QMessageBox.about(self,'aGrae GIS', 'Debe Seleccionar una parcela para agregar a la relacion')     
           
class loteFindDialog(QtWidgets.QDialog, agraeLoteDialog):
    closingPlugin = pyqtSignal()
    actualizar = pyqtSignal(list)
    actualizarRel = pyqtSignal(str)  
    def __init__(self, parent=None):

        """Constructor."""
        super(loteFindDialog, self).__init__(parent)      
        self.utils = AgraeUtils()
        self.conn = self.utils.Conn()
        data = self.data()
        try: 
            lista = [e[1] for e in data]
        except: 
            lista = []
        completer = QCompleter(lista)
        completer.setCaseSensitivity(False)
        self.setupUi(self)
        self.btn_buscar.clicked.connect(self.buscar)
        self.lineEdit.setCompleter(completer)
        self.tableWidget.horizontalHeader().setStretchLastSection(True)
        self.btn_cargar_lote.clicked.connect(self.cargarLote)
        self.pushButton_2.clicked.connect(self.crearRelacionLoteParcela)

    def closeEvent(self, event):
        self.closingPlugin.emit()
        event.accept()

    def data(self, filtro=None):
        if filtro == None:
            cursor = self.conn.cursor()
            sql = """select lc.idlotecampania , l.nombre lote, (case when sq1.parcelas >= 1 then coalesce(sq1.parcelas,0)::varchar(10) else 'No' end) parcelas, 
            ca.fechasiembra, ca.fechacosecha, cu.nombre cultivo
            from lote l
            left join lotecampania lc on lc.idlote = l.idlote 
            left join 
                (select lc2.idlotecampania, count(*) parcelas from loteparcela lc2 group by idlotecampania ) as sq1 
                on sq1.idlotecampania = lc.idlotecampania
            left join campania ca on ca.idcampania = lc.idcampania 
            left join cultivo cu on cu.idcultivo = ca.idcultivo 
            order by ca.fechasiembra asc"""
            cursor.execute(sql)
            data = cursor.fetchall()
        else:
            cursor = self.conn.cursor()
            sql = f"""select lc.idlotecampania , l.nombre lote, (case when sq1.parcelas >= 1 then coalesce(sq1.parcelas,0)::varchar(10) else 'No' end) parcelas, 
            ca.fechasiembra, ca.fechacosecha, cu.nombre cultivo
            from lote l
            left join lotecampania lc on lc.idlote = l.idlote 
            left join 
                (select lc2.idlotecampania, count(*) parcelas from loteparcela lc2 group by idlotecampania ) as sq1 
                on sq1.idlotecampania = lc.idlotecampania
            left join campania ca on ca.idcampania = lc.idcampania 
            left join cultivo cu on cu.idcultivo = ca.idcultivo 
            where l.nombre ilike '%{filtro}%' 
            order by ca.fechasiembra asc """
            cursor.execute(sql)
            data = cursor.fetchall()
        if len(data) >= 1:
            return data
        elif len(data) == 0:
            data = [0, 0]
            return data

    def populate(self,data):
        try:
            a = len(data)
            b = len(data[0])
            i = 1
            j = 1
            self.tableWidget.setRowCount(a)
            self.tableWidget.setColumnCount(b)
            for j in range(a):
                for i in range(b):
                    item = QTableWidgetItem(str(data[j][i]))
                    self.tableWidget.setItem(j, i, item)
        except:
            QMessageBox.about(self, "Error:", "No Existen Registros")
            print('error')


    def loadData(self,param=None):
        

        if param == None:  

            data = self.data()

            # print(data[0][1])
            self.populate(data)

        else:

            data = self.data(param)

            # print(data[0][1])
            self.populate(data)
        pass


    def buscar(self):

        filtro = self.lineEdit.text()

        self.loadData(filtro)
        pass

    def cargarLote(self):

        try:
            try: 
                row = self.tableWidget.currentRow()
                param = self.tableWidget.item(row, 0).text()
                sqlQuery = f""" select
                l.idlote, ca.idexplotacion, ca.idcultivo, l.nombre, ca.fechasiembra, ca.fechacosecha,
                --fondo
                ca.fechafertilizacionfondo, ca.fertilizantefondoformula, ca.fertilizantefondoprecio, ca.fertilizantefondocalculado,
                ca.fertilizantefondoajustado, ca.fertilizantefondoaplicado,
                -- cob1
                ca.fechafertilizacioncbo1, ca.fertilizantecob1formula, ca.fertilizantecob1precio, ca.fertilizantecob1calculado,
                ca.fertilizantecob1ajustado, ca.fertilizantecob1aplicado,
                -- cob2
                ca.fechafertilizacioncbo2, ca.fertilizantecob2formula, ca.fertilizantecob2precio, ca.fertilizantecob2calculado,
                ca.fertilizantecob2ajustado, ca.fertilizantecob2aplicado,
                -- cob3
                ca.fechafertilizacioncbo3, ca.fertilizantecob3formula, ca.fertilizantecob3precio, ca.fertilizantecob3calculado,
                ca.fertilizantecob3ajustado, ca.fertilizantecob3aplicado
                from lote l
                left join lotecampania lc on lc.idlote = l.idlote
                left join campania ca on ca.idcampania = lc.idcampania   
                where lc.idlotecampania = {param} """
                conn = self.conn
                cursor = conn.cursor()
                cursor.execute(sqlQuery)
                data = cursor.fetchone()
                dataLista = list(data)
                self.actualizar.emit(dataLista)
                self.close()

            except:                
                data = self.tableWidget.item(row, 1).text()
                dataLista = [data]
                self.actualizar.emit(dataLista)
                QMessageBox.about(self, 'aGrae GIS', 'El Lote que selecciono no tiene una campaña\nasociada, porfavor cree una nueva campaña para este lote.')
                self.close()
        except Exception as ex:
            print(ex)            
            QMessageBox.about(self, 'Error','Ocurrio un Error')
            pass      


    def insertarIdRelacion(self):

        try:

            row = self.tableWidget.currentRow()

            column = self.tableWidget.currentColumn()

            idRel = self.tableWidget.item(row, 0).text()

            self.actualizarRel.emit(idRel)
            self.close()

        except Exception as ex:

            QMessageBox.about(self, 'aGrae GIS','Debe Seleccionar un lote de la Lista para agregar a la relacion')
                  
    def crearRelacionLoteParcela(self):
        lyr = iface.activeLayer() 
        features = lyr.selectedFeatures()         
        row = self.tableWidget.currentRow()
        idLote = self.tableWidget.item(row,0).text()
        errors = []
        try:
            for f in features: 
                print(f[1],idLote)       
                idParcela = f[1]
                try:
                    sql = f''' insert into loteparcela(idparcela,idlotecampania) 
                            values({idParcela},{idLote}) '''
                    cursor = self.conn.cursor()
                    cursor.execute(sql)
                    print(f'Se creo la Relacion {idParcela,idLote}')
                    self.conn.commit()

                except errors.lookup('23505'):
                    errors.append(idParcela)
                    print(f'La parcela {f[1]} ya existe pertenece a un lote.')
                    self.conn.rollback()
            
            if len(errors) == 0:
                QMessageBox.about(self, 'aGrae GIS', f'Se creo la Relacion sin errores ') 
            elif len(errors) >0 and len(errors) <len(features): 
                QMessageBox.about(self, 'aGrae GIS', f' Las siguientes parcelas no se pudieron relacionar \n ({errors})')
            elif len(errors) == len(features): 
                QMessageBox.about(self, 'aGrae GIS', f'No se pudieron relacionar las Parcelas seleccionadas.')

                

        except Exception as ex: 
            print(ex)
            QMessageBox.about(self, 'aGrae GIS', f'Ocurrio un Error. ')



class expFindDialog(QtWidgets.QDialog, agraeExpDialog):
    closingPlugin = pyqtSignal()
    def __init__(self, parent=None):
        """Constructor."""
        super(expFindDialog, self).__init__(parent)
        self.utils = AgraeUtils()
        self.conn = self.utils.Conn()
        data = self.dataAuto()
        lista = [e[0] for e in data]
        # print(lista)
        completer = QCompleter(lista)
        completer.setCaseSensitivity(False)
        # Set up the user interface from Designer.
        # After setupUI you can access any designer object by doing
        # self.<objectname>, and you can use autoconnect slots - see
        # http://doc.qt.io/qt-5/designer-using-a-ui-file.html
        # #widgets-and-dialogs-with-auto-connect
        self.setupUi(self)
        self.btn_buscar.clicked.connect(self.buscar)
        self.lineEdit.setCompleter(completer)
        self.tableWidget.horizontalHeader().setStretchLastSection(True)

    def closeEvent(self, event):
        self.closingPlugin.emit()
        event.accept()

    def data(self, filtro=None):
        if filtro == None:
            cursor = self.conn.cursor()
            sql = "select idexplotacion,nombre, direccion from explotacion order by idexplotacion"
            cursor.execute(sql)
            data = cursor.fetchall()
        else:
            cursor = self.conn.cursor()
            sql = f"select idexplotacion,nombre, direccion from explotacion where nombre ilike '%{filtro}%' or direccion ilike '%{filtro}%' order by idexplotacion "
            cursor.execute(sql)
            data = cursor.fetchall()
        if len(data) >= 1:
            return data
        elif len(data) == 0:
            data = [0, 0]
            return data
    def dataAuto(self):
        cursor = self.conn.cursor()
        sql = "select nombre from explotacion union select direccion from explotacion"
        cursor.execute(sql)
        data = cursor.fetchall()
        return data

    def populate(self, data):
        try:
            a = len(data)
            b = len(data[0])
            i = 1
            j = 1
            self.tableWidget.setRowCount(a)
            self.tableWidget.setColumnCount(b)
            for j in range(a):
                for i in range(b):
                    item = QTableWidgetItem(str(data[j][i]))
                    self.tableWidget.setItem(j, i, item)
        except:
            QMessageBox.about(self, "Error:", "No Existen Registros")
            print('error')

    def loadData(self, param=None):
        if param == None:
            data = self.data()
            self.populate(data)
        else:
            data = self.data(param)
            self.populate(data)
        pass

    def buscar(self):
        filtro = self.lineEdit.text()
        self.loadData(filtro)
        pass




class cultivoFindDialog(QtWidgets.QDialog, agraeCultivoDialog):

    closingPlugin = pyqtSignal()
    def __init__(self, parent=None):
        """Constructor."""
        super(cultivoFindDialog, self).__init__(parent)
        self.utils = AgraeUtils()
        self.conn = self.utils.Conn()
        data = self.dataAuto()
        lista = [e[0] for e in data]
        # print(lista)
        completer = QCompleter(lista)
        completer.setCaseSensitivity(False)
        self.setupUi(self)
        self.btn_buscar.clicked.connect(self.buscar)
        self.lineEdit.setCompleter(completer)
        self.tableWidget.horizontalHeader().setStretchLastSection(True)
    def closeEvent(self, event):
        self.closingPlugin.emit()
        event.accept()

    def data(self, filtro=None):
        if filtro == None:
            cursor = self.conn.cursor()
            sql = "select idcultivo,nombre from cultivo order by idcultivo"
            cursor.execute(sql)
            data = cursor.fetchall()
        else:
            cursor = self.conn.cursor()
            sql = f"select idcultivo,nombre from cultivo where nombre ilike '%{filtro}%' order by idcultivo"
            cursor.execute(sql)
            data = cursor.fetchall()
        if len(data) >= 1:
            return data
        elif len(data) == 0:
            data = [0, 0]
            return data

    def dataAuto(self):
        cursor = self.conn.cursor()
        sql = "select nombre from cultivo"
        cursor.execute(sql)
        data = cursor.fetchall()
        return data


    def populate(self, data):
        try:
            a = len(data)
            b = len(data[0])
            i = 1
            j = 1
            self.tableWidget.setRowCount(a)
            self.tableWidget.setColumnCount(b)
            for j in range(a):
                for i in range(b):
                    item = QTableWidgetItem(str(data[j][i]))
                    self.tableWidget.setItem(j, i, item)
        except:
            QMessageBox.about(self, "Error:", "No Existen Registros")
            print('error')

    def loadData(self, param=None):
        if param == None:
            data = self.data()
            self.populate(data)
        else:
            data = self.data(param)
            self.populate(data)
        pass

    def buscar(self):
        filtro = self.lineEdit.text()
        self.loadData(filtro)
        pass


class ReadOnlyDelegate(QtWidgets.QStyledItemDelegate):
    def createEditor(self, parent, option, index):
        return


class agraeMainWidget(QtWidgets.QMainWindow, agraeMainPanel):

    closingPlugin = pyqtSignal()
    def __init__(self, parent=None):
        """Constructor."""      
        super(agraeMainWidget, self).__init__(parent)  

        self.utils = AgraeUtils()
        self.tools = AgraeToolset()
        self.conn = self.utils.Conn()
        self.style = self.utils.styleSheet()
        self.idlote = None
        self.sqlParcela = ''
        self.sqlSegmento = ''

        self.sinceDateStatus = False

        

        
              
        self.setupUi(self)
        self.UIcomponents()
        self.populateComboProv()
        self.populateComboMcpo(self.prov_combo.currentData())
        self.setLineFormatValidator()
        self.setStyleLines()

        





    def UIcomponents(self):
        icons_path = self.utils.iconsPath()

        dataParcela = self.dataAutoParcela()
        listaParcela = [e[0] for e in dataParcela]
        # print(listaParcela)
        completerParcela = QCompleter(listaParcela)
        completerParcela.setCaseSensitivity(False)

        dataSegmento = self.dataAutoSegmento()
        listaSegmento = [e[0] for e in dataSegmento]
        completerSegmento = QCompleter(listaSegmento)
        completerSegmento.setCaseSensitivity(False)

        self.tableWidget.horizontalHeader().setStretchLastSection(True)
        # columna geometria lote parcela
        self.tableWidget.setColumnHidden(6, True) # columna geometria loteparcela
        self.tableWidget.setColumnHidden(0, True)  # columna id lote parcela

        # self.tableWidget_2.setColumnHidden(5, True) # columna geometria segmento
        self.tableWidget_2.horizontalHeader().setStretchLastSection(True)
        self.tableWidget_2.setColumnHidden(0, True)
        self.tableWidget_2.setColumnHidden(1, True)
        self.tableWidget_2.setColumnHidden(2, True)

        delegate = ReadOnlyDelegate(self.tableWidget_2)
        self.tableWidget_2.setItemDelegateForColumn(0, delegate)
        self.tableWidget_2.setItemDelegateForColumn(1, delegate)
        self.tableWidget_2.setItemDelegateForColumn(2, delegate)
        self.tableWidget_2.setItemDelegateForColumn(3, delegate)
        self.tableWidget_2.setItemDelegateForColumn(4, delegate)
        self.tableWidget_2.setItemDelegateForColumn(5, delegate)
        self.tableWidget_2.setItemDelegateForColumn(6, delegate)
        self.tableWidget_2.setItemDelegateForColumn(7, delegate)

        self.line_buscar.setClearButtonEnabled(True)
        line_par_action = self.ln_par_nombre.addAction(
            QIcon(icons_path['search_icon_path']), self.ln_par_nombre.TrailingPosition)
        line_par_action.triggered.connect(self.parcelaDialog)
        line_lote_action = self.line_lote_nombre.addAction(
            QIcon(icons_path['search_icon_path']), self.line_lote_nombre.TrailingPosition)
        line_lote_action.triggered.connect(self.loteDialog)
        line_loteidexp_action = self.line_lote_idexp.addAction(
            QIcon(icons_path['search_icon_path']), self.line_lote_idexp.TrailingPosition)
        line_loteidexp_action.triggered.connect(self.expDialog)
        line_loteidcultivo_action = self.line_lote_idcultivo.addAction(
            QIcon(icons_path['search_icon_path']), self.line_lote_idcultivo.TrailingPosition)
        line_loteidcultivo_action.triggered.connect(self.cultivoDialog)
        line_buscar_action = self.line_buscar.addAction(
                    QIcon(icons_path['search_icon_path']), self.line_buscar.TrailingPosition)
        line_buscar_action.triggered.connect(self.buscarLotes)

        self.btn_add_layer.setIcon(QIcon(icons_path['add_layer_to_map']))
        self.btn_add_layer.setIconSize(QtCore.QSize(20, 20))
        self.btn_add_layer_2.setIcon(QIcon(icons_path['add_layer_to_map']))
        self.btn_add_layer_2.setIconSize(QtCore.QSize(20, 20))

        self.btn_par_update.clicked.connect(self.actualizarParcela)
        self.btn_buscar_parcela_2.clicked.connect(self.parcelaDialog)
        self.btn_buscar_lote_2.clicked.connect(self.loteDialog)
        self.btn_rel_create.clicked.connect(self.crearRelacionLoteParcela)
        self.btn_lote_update.clicked.connect(self.actualizarLote)
        self.prov_combo.currentTextChanged.connect(self.indexProvUpdate)
        self.setStyleSheet(self.style)
        self.line_buscar.setCompleter(completerParcela)
        self.line_find_segmento.setCompleter(completerSegmento)
        self.btn_crear_lote.clicked.connect(self.crearLote)
        self.btn_crear_campania.clicked.connect(self.crearCampania)
        self.ln_par_nombre.textChanged.connect(self.validarNombre)
        self.pushButton_3.clicked.connect(self.crearAmbientes)
        self.pushButton_4.clicked.connect(self.segmentoDialog)
        self.btn_par_create.clicked.connect(self.crearParcela)
        self.pushButton.clicked.connect(self.cargarParcela)
        self.btn_find_segmento.clicked.connect(self.buscarSegmento)

    
        self.btn_add_layer.clicked.connect(self.cargarLote)

        self.btn_reload.setIcon(QIcon(icons_path['reload_data']))
        self.btn_reload.setIconSize(QtCore.QSize(20, 20))
        self.btn_reload.setToolTip('Buscar todos los lotes')
        self.btn_reload.clicked.connect(self.reloadLotes)



    def closeEvent(self, event):
        self.closingPlugin.emit()
        event.accept()

    def dataAutoParcela(self): 
        cursor = self.conn.cursor()
        sql = '''select distinct unnest(array[l.nombre, p.nombre, c.nombre]) from lote l
        left join lotecampania lc on lc.idlote = l.idlote
        left join campania ca on ca.idcampania = lc.idcampania 
        left join loteparcela lp on lc.idlotecampania = lp.idlotecampania 
        left join parcela p on lp.idparcela = p.idparcela
        left join cultivo c on c.idcultivo = ca.idcultivo'''
        cursor.execute(sql)
        data = cursor.fetchall()
        return data
    def dataAutoSegmento(self): 
        cursor = self.conn.cursor()
        sql = '''select distinct unnest(array[s.cod_control, l.nombre, a.cod_analisis]) lista from segmento s
            join lote l on s.idlote = l.idlote 
            left join segmentoanalisis sa on s.idsegmento = sa.idsegmento
            left join analisis a on a.idanalisis = sa.idanalisis
            order by lista '''
        # cursor.execute(sql)
        # data = cursor.fetchall()
        data = []
        return data
    def actualizarParcela(self):
        idParcela = self.lbl_id_parcela.text()
        name = self.ln_par_nombre.text()
        prov = int(self.prov_combo.currentData())
        mcpo = int(self.mcpo_combo.currentData())
        aggregate = self.ln_par_agg.text()
        zone = self.ln_par_zona.text()
        poly = self.ln_par_poly.text()
        allotment = self.ln_par_parcela.text()
        inclosure = self.ln_par_recinto.text()
        confirm = QMessageBox.question(self, 'aGrae GIS', f"Seguro quiere Actualizar la parcela:\n--- ID: {idParcela}\n--- Nombre: {name.upper()}?", QMessageBox.Yes | QMessageBox.No, QMessageBox.No)
        if confirm == QMessageBox.Yes:
            with self.conn as conn:
                try:
                    # sql = f'''update parcela set nombre = '{name}', provincia = {prov}, municipio = {mcpo}, agregado = '{aggregate}', zona = '{zone}', poligono = '{poly}', parcela = '{allotment}', recinto = '{inclosure}' where idparcela = '{idParcela}' '''               
                    sql = f'''update parcela set nombre = '{name}', provincia = {prov}, municipio = {mcpo}  where idparcela = '{idParcela}' '''  # ! SENTENCIA TEMPORAL
                    cursor = conn.cursor()
                    cursor.execute(sql)
                    conn.commit()
                    QMessageBox.about(self, f"aGrae GIS:",f"Parcela *-- {name} --* Se modifico Correctamente.")
                    self.btn_par_update.setEnabled(False)
                except Exception as ex:
                    QMessageBox.about(self, f"Error:",f"{ex} \nHa ocurrido un Error por favor, verifique los datos o contacese con soporte tecnico")
        else:
            pass
    def actualizarLote(self):
        idlote = self.idlote
        nombre = self.line_lote_nombre.text()
        idexp = self.line_lote_idexp.text()
        idcult = self.line_lote_idcultivo.text()
        dateSiembra = self.lote_dateSiembra.date().toString('yyyy.MM.dd')
        dateCosecha = self.lote_dateCosecha.date().toString('yyyy.MM.dd')
        dateFondo = self.date_fondo.date().toString('yyyy.MM.dd')
        fondoFormula = self.line_fondo_formula.text()
        fondoPrecio = float(self.line_fondo_precio.text())
        fondoCalculado = float(self.line_fondo_calculado.text())
        fondoAjustado = float(self.line_fondo_ajustado.text())
        fondoAplicado = float(self.line_fondo_aplicado.text())
        dateCob1 = self.date_cob.date().toString('yyyy.MM.dd')
        cob1Formula = self.line_cob_formula.text()
        cob1Precio = float(self.line_cob_precio.text())
        cob1Calculado = float(self.line_cob_calculado.text())
        cob1Ajustado = float(self.line_cob_ajustado.text())
        cob1Aplicado = float(self.line_cob_aplicado.text())
        dateCob2 = self.date_cob_2.date().toString('yyyy.MM.dd')
        cob2Formula = self.line_cob_formula_2.text()
        cob2Precio = float(self.line_cob_precio_2.text())
        cob2Calculado = float(self.line_cob_calculado_2.text())
        cob2Ajustado = float(self.line_cob_ajustado_2.text())
        cob2Aplicado = float(self.line_cob_aplicado_2.text())
        dateCob3 = self.date_cob_3.date().toString('yyyy.MM.dd')
        cob3Formula = self.line_cob_formula_3.text()
        cob3Precio = float(self.line_cob_precio_3.text())
        cob3Calculado = float(self.line_cob_calculado_3.text())
        cob3Ajustado = float(self.line_cob_ajustado_3.text())
        cob3Aplicado = float(self.line_cob_aplicado_3.text())
        confirm = QMessageBox.question(self, 'aGrae GIS', f"Seguro quiere Actualizar el Lote:\n--- ID: {idlote}\n--- Nombre: {nombre.upper()}?", QMessageBox.Yes | QMessageBox.No, QMessageBox.No)
        if confirm == QMessageBox.Yes:
            try:             
                sql = f'''update lote set  idexplotacion = '{idexp}', idcultivo = '{idcult}', nombre = '{nombre}',fechasiembra = '{dateSiembra}',fechacosecha = '{dateCosecha}',fechafertilizacionfondo = '{dateFondo}',    fertilizantefondoformula = '{fondoFormula}',fertilizantefondoprecio = {fondoPrecio}, fertilizantefondocalculado = {fondoCalculado},fertilizantefondoajustado = {fondoAjustado},  fertilizantefondoaplicado = {fondoAplicado},fechafertilizacioncbo1 = '{dateCob1}', fertilizantecob1formula ='{cob1Formula}',fertilizantecob1precio = {cob1Precio}, fertilizantecob1calculado = {cob1Calculado},fertilizantecob1ajustado = {cob1Ajustado}, fertilizantecob1aplicado = {cob1Aplicado},fechafertilizacioncbo2 = '{dateCob2}', fertilizantecob2formula = '{cob2Formula}', fertilizantecob2precio = {cob2Precio},  fertilizantecob2calculado = {cob2Calculado}, fertilizantecob2ajustado = {cob2Ajustado}, fertilizantecob2aplicado ={cob2Aplicado},fechafertilizacioncbo3 = '{dateCob3}', fertilizantecob3formula = '{cob3Formula}',fertilizantecob3precio = {cob3Precio}, fertilizantecob3calculado = {cob3Calculado},fertilizantecob3ajustado = {cob3Ajustado}, fertilizantecob3aplicado = {cob3Aplicado} where idlote = {idlote} '''
                # print(sql)      
                conn = self.conn
                cursor = conn.cursor()
                cursor.execute(sql)
                conn.commit()
                QMessageBox.about(self, f"aGrae GIS:",f"Lote *-- {nombre.upper()} --* Se modifico Correctamente.")
            except Exception as e: 
                cursor.rollback()
                QMessageBox.about(self,'aGrae GIS:',f'Ocurrio un Error. \n {e}')

        else:
            pass  
    def crearParcela(self):
        self.tools.crearParcela(self)
    
    def crearCampania(self):
        lote = str(self.line_lote_nombre.text()).upper()
        idexp = self.line_lote_idexp.text()
        idcult = self.line_lote_idcultivo.text()
        dateSiembra = self.lote_dateSiembra.date().toString('yyyy.MM.dd')
        dateCosecha = self.lote_dateCosecha.date().toString('yyyy.MM.dd')
        dateFondo = self.date_fondo.date().toString('yyyy.MM.dd')
        fondoFormula = self.line_fondo_formula.text()
        fondoPrecio = float(self.line_fondo_precio.text())
        fondoCalculado = float(self.line_fondo_calculado.text())
        fondoAjustado = float(self.line_fondo_ajustado.text())
        fondoAplicado = float(self.line_fondo_aplicado.text())
        dateCob1 = self.date_cob.date().toString('yyyy.MM.dd')
        cob1Formula = self.line_cob_formula.text()
        cob1Precio = float(self.line_cob_precio.text())
        cob1Calculado = float(self.line_cob_calculado.text())
        cob1Ajustado = float(self.line_cob_ajustado.text())
        cob1Aplicado = float(self.line_cob_aplicado.text())
        dateCob2 = self.date_cob_2.date().toString('yyyy.MM.dd')
        cob2Formula = self.line_cob_formula_2.text()
        cob2Precio = float(self.line_cob_precio_2.text())
        cob2Calculado = float(self.line_cob_calculado_2.text())
        cob2Ajustado = float(self.line_cob_ajustado_2.text())
        cob2Aplicado = float(self.line_cob_aplicado_2.text())
        dateCob3 = self.date_cob_3.date().toString('yyyy.MM.dd')
        cob3Formula = self.line_cob_formula_3.text()
        cob3Precio = float(self.line_cob_precio_3.text())
        cob3Calculado = float(self.line_cob_calculado_3.text())
        cob3Ajustado = float(self.line_cob_ajustado_3.text())
        cob3Aplicado = float(self.line_cob_aplicado_3.text())
        unidadDesprecio = self.ln_und_deprecio.text()
      
        sql = f'''
        insert into campania 
        values(nextval('campania_idcampania_seq') ,{idexp}, {idcult},'{dateSiembra}','{dateCosecha}', '{dateFondo}','{fondoFormula}',{fondoPrecio}, {fondoCalculado}, {fondoAjustado},  {fondoAplicado}, '{dateCob1}', '{cob1Formula}', {cob1Precio},  {cob1Calculado}, {cob1Ajustado},  {cob1Aplicado}, '{dateCob2}',  '{cob2Formula}',  {cob2Precio},   {cob2Calculado},  {cob2Ajustado}, {cob2Aplicado}, '{dateCob3}',  '{cob3Formula}', {cob3Precio},  {cob3Calculado}, {cob3Ajustado},  {cob3Aplicado} , '{unidadDesprecio}');
        '''

        sql2 = f'''insert into lotecampania(idlote,idcampania) 
        select ql.idlote, qc.idcampania from (select idlote from lote where nombre ilike '%{lote}%') as ql, (select idcampania from campania order by idcampania desc limit 1) as qc; '''
       
        with self.conn as conn:
            try: 
                cursor = conn.cursor()
                cursor.execute(sql)
                conn.commit()
                cursor.execute(sql2)
                conn.commit()
                QMessageBox.about(self, f"aGrae GIS:",f"Campaña y asociada creada correctamente")
            except InterfaceError as ie: 
                conn = self.utils.Conn()
                cursor = conn.cursor()
                cursor.execute(sql)
                QMessageBox.about(self, f"aGrae GIS:", f"Campaña creada correctamente")


            except Exception as e: 
                print(e)
                QMessageBox.about(self, f"Error: ",f"{e}")         
    
    def crearLote(self): 
        nombre = str(self.line_lote_nombre.text()).upper()
        sql = f""" insert into lote(nombre) values('{nombre}')  """
        with self.conn as conn: 
            try: 
                cursor = conn.cursor()
                cursor.execute(sql)
                print('Lote creado')
                QMessageBox.about(
                    self, f"aGrae GIS:", f"Lote: {nombre} Creado Correctamente.\nCrear Relacion Lote Parcelas.")
            except errors.lookup('23505'): 
                print('El lote ya existe, ingresa otro nombre o modifica el existente')
                QMessageBox.about(self, f"aGrae GIS:",f"El Lote: {nombre} ya existe.\nIngresa otro Nombre o Modifica el Existente")
                conn.rollback()
            except Exception as ex: 
                print(ex)
                QMessageBox.about(self, f"ERROR:",f"Ocurrio un Error, Revisa la Consola")
                conn.rollback()

    def populateParcela(self,data):
        style = "font-weight: bold ; color : red"
        dataStr = [str(e) for e in data]
        self.lbl_id_parcela.setText(dataStr[1])
        self.ln_par_nombre.setText(dataStr[2])
        # self.ln_par_provincia.setText(dataStr[3])            
        # if dataStr[11] != None:
        idxProv = self.prov_combo.findData(dataStr[3])
        self.prov_combo.setCurrentIndex(idxProv)           
        idxMcpo = self.mcpo_combo.findData(dataStr[4])
        self.mcpo_combo.setCurrentIndex(idxMcpo)
        # self.ln_par_mcpo.setText(dataStr[3])
        self.ln_par_agg.setText(dataStr[5])
        self.ln_par_zona.setText(dataStr[6])
        self.ln_par_poly.setText(dataStr[7])
        self.ln_par_parcela.setText(dataStr[8])
        self.ln_par_recinto.setText(dataStr[9])
        self.btn_par_create.setEnabled(False)
        self.btn_par_update.setEnabled(True)
        self.pushButton.setEnabled(True)

    def populateLote(self, data):
        # print(data)
        self.resetStyleLabels()
        data2 = []
        style = "font-weight: bold ; color : red"
        for e in data:
            if e == None:
                data2.append(e)
            else:
                data2.append(str(e))
        if len(data) == 1: 
            self.line_lote_nombre.setText(data[0])
        else: 
            try:
                self.idlote = data[0]
                self.lbl_id_lote.setText(data2[0])
                self.line_lote_idexp.setText(data2[1])
                self.line_lote_idcultivo.setText(data2[2])
                self.line_lote_nombre.setText(data2[3])
                try:
                    self.lote_dateSiembra.setDate(data[4])
                except:
                    self.label_5.setStyleSheet(style)              
                try:
                    self.lote_dateCosecha.setDate(data[5])
                except:
                    self.label_6.setStyleSheet(style)
                    pass
                try:
                    self.lote_dateFondo.setDate(data[6])
                except:
                    self.label_13.setStyleSheet(style)
                    pass
                self.line_fondo_formula.setText(data2[7])
                self.line_fondo_precio.setText(data2[8])
                self.line_fondo_calculado.setText(data2[9])
                self.line_fondo_ajustado.setText(data2[10])
                self.line_fondo_aplicado.setText(data2[11])
                try:
                    self.date_cob.setDate(data[12])
                except:
                    self.label_15.setStyleSheet(style)
                    pass
                self.line_cob_formula.setText(data2[13])
                self.line_cob_precio.setText(data2[14])
                self.line_cob_calculado.setText(data2[15])
                self.line_cob_ajustado.setText(data2[16])
                self.line_cob_aplicado.setText(data2[17])
                try:
                    self.date_cob_2.setDate(data[18])
                except:
                    self.label_20.setStyleSheet(style)
                    pass
                self.line_cob_formula_2.setText(data2[19])
                self.line_cob_precio_2.setText(data2[20])
                self.line_cob_calculado_2.setText(data2[21])
                self.line_cob_ajustado_2.setText(data2[22])
                self.line_cob_aplicado_2.setText(data2[23])
                try:
                    self.date_cob_3.setDate(data[24])
                except:
                    self.label_26.setStyleSheet(style)
                    pass
                self.line_cob_formula_3.setText(data2[25])
                self.line_cob_precio_3.setText(data2[26])
                self.line_cob_calculado_3.setText(data2[27])
                self.line_cob_ajustado_3.setText(data2[28])
                self.line_cob_aplicado_3.setText(data2[29])
                self.btn_lote_update.setEnabled(True)
            except Exception as ex:
                print(ex)
                pass

    def populateRelPar(self,idPar):
        self.ln_rel_parcela.setText(idPar)


    def populateRelLote(self,idLote):
        self.ln_rel_lote.setText(idLote)
  
    def returnSql(self,sql):
        self.sqlParcela = sql
        # print(self.sqlParcela)

    def parcelaDialog(self):       

        dialog = parcelaFindDialog()
        dialog.loadData()
        dialog.actualizar.connect(self.populateParcela)
        dialog.actualizarRel.connect(self.populateRelPar)
        dialog.sqlSignal.connect(self.returnSql)

        dialog.exec_()
    
    def loteDialog(self):     
        dialog = loteFindDialog()
        dialog.loadData()
        dialog.actualizar.connect(self.populateLote)
        dialog.actualizarRel.connect(self.populateRelLote)
        dialog.exec_()  

    def expDialog(self):
        dialog = expFindDialog()
        dialog.loadData()
        dialog.exec_()
    
    def cultivoDialog(self):
        dialog = cultivoFindDialog()
        dialog.loadData()
        dialog.exec_()

    def crearRelacionLoteParcela(self):
        idParcela = int(self.ln_rel_parcela.text())
        idLote = int(self.ln_rel_lote.text())
        try:         
            sql = f''' insert into loteparcela(idparcela,idlotecampania) 
                    values({idParcela},{idLote}) '''
            cursor = self.conn.cursor()
            cursor.execute(sql)
            QMessageBox.about(self, 'aGrae GIS','Se creo la Relacion')
            self.conn.commit() 



        except errors.lookup('23505'):
            QMessageBox.about(self, 'aGrae GIS', 'La parcela ya existe pertenece a un lote.')              
 



    def resetStyleLabels(self):
        style = 'font-weight: normal ; color : black'
        self.label_5.setStyleSheet(style)
        self.label_6.setStyleSheet(style)
        self.label_13.setStyleSheet(style)
        self.label_15.setStyleSheet(style)
        self.label_20.setStyleSheet(style)
        self.label_26.setStyleSheet(style)


    def setLineFormatValidator(self):
        self.doubleFormat = QRegExpValidator(QRegExp(r'^[0-9]\d*(\.\d+)?$'))
        self.line_fondo_precio.setValidator(self.doubleFormat)
        self.line_fondo_calculado.setValidator(self.doubleFormat)
        self.line_fondo_ajustado.setValidator(self.doubleFormat)
        self.line_fondo_aplicado.setValidator(self.doubleFormat)
        self.line_cob_precio.setValidator(self.doubleFormat)
        self.line_cob_calculado.setValidator(self.doubleFormat)
        self.line_cob_ajustado.setValidator(self.doubleFormat)
        self.line_cob_aplicado.setValidator(self.doubleFormat)
        self.line_cob_precio_2.setValidator(self.doubleFormat)
        self.line_cob_calculado_2.setValidator(self.doubleFormat)
        self.line_cob_ajustado_2.setValidator(self.doubleFormat)
        self.line_cob_aplicado_2.setValidator(self.doubleFormat)
        self.line_cob_precio_3.setValidator(self.doubleFormat)
        self.line_cob_calculado_3.setValidator(self.doubleFormat)
        self.line_cob_ajustado_3.setValidator(self.doubleFormat)
        self.line_cob_aplicado_3.setValidator(self.doubleFormat)

        ###########################################################

        self.integerFormat = QRegExpValidator(QRegExp(r'^[0-9]\d*$'))
        self.ln_par_agg.setValidator(self.integerFormat)
        self.ln_par_zona.setValidator(self.integerFormat)
        self.ln_par_poly.setValidator(self.integerFormat)
        self.ln_par_parcela.setValidator(self.integerFormat)
        self.ln_par_recinto.setValidator(self.integerFormat)
        self.line_lote_idexp.setValidator(self.integerFormat)
        self.line_lote_idcultivo.setValidator(self.integerFormat)

        ##############################################################

        self.untilDate.setDate(QDate.currentDate())

    def validarNombre(self):
        if self.ln_par_nombre.text() != '':
            self.btn_par_create.setEnabled(True)
            self.btn_par_update.setEnabled(True)
        
        if self.line_lote_nombre.text() != '':
            self.btn_crear_lote.setEnabled(True)
            self.btn_crear_campania.setEnabled(True)
        
            




    def setStyleLines(self):
        style = ''' color: black ; font-weight: bold  '''
        self.ln_par_nombre.setStyleSheet(style)
        self.ln_par_agg.setStyleSheet(style)
        self.ln_par_zona.setStyleSheet(style)
        self.ln_par_poly.setStyleSheet(style)
        self.ln_par_parcela.setStyleSheet(style)
        self.ln_par_recinto.setStyleSheet(style)
        self.ln_rel_parcela.setStyleSheet(style)
        self.ln_rel_lote.setStyleSheet(style)
        self.line_lote_nombre.setStyleSheet(style)
        self.line_lote_idexp.setStyleSheet(style)
        self.line_lote_idcultivo.setStyleSheet(style)
        self.line_fondo_formula.setStyleSheet(style)
        self.line_fondo_precio.setStyleSheet(style)
        self.line_fondo_calculado.setStyleSheet(style)
        self.line_fondo_ajustado.setStyleSheet(style)
        self.line_fondo_aplicado.setStyleSheet(style)
        self.line_cob_formula.setStyleSheet(style)
        self.line_cob_precio.setStyleSheet(style)
        self.line_cob_calculado.setStyleSheet(style)
        self.line_cob_ajustado.setStyleSheet(style)
        self.line_cob_aplicado.setStyleSheet(style)
        self.line_cob_formula_2.setStyleSheet(style)
        self.line_cob_precio_2.setStyleSheet(style)
        self.line_cob_calculado_2.setStyleSheet(style)
        self.line_cob_ajustado_2.setStyleSheet(style)
        self.line_cob_aplicado_2.setStyleSheet(style)
        self.line_cob_formula_3.setStyleSheet(style)
        self.line_cob_precio_3.setStyleSheet(style)
        self.line_cob_calculado_3.setStyleSheet(style)
        self.line_cob_ajustado_3.setStyleSheet(style)
        self.line_cob_aplicado_3.setStyleSheet(style)

    def populateComboProv(self): 
        conn = self.conn
        cursor = conn.cursor(cursor_factory = extras.RealDictCursor)
        cursor.execute('select nombre,idprovincia from datos.provincia order by nombre')
        datos = cursor.fetchall()
        for row in datos: 
            self.prov_combo.addItem(row["nombre"],row["idprovincia"])        
        self.prov_combo.setStyleSheet("QComboBox { combobox-popup: 0; font-size: 10pt}")
    def indexProvUpdate(self):
        idprov = str(self.prov_combo.currentData())
        print(idprov)
        self.mcpo_combo.clear()
        self.populateComboMcpo(idprov)   
    def populateComboMcpo(self,idprov):
        self.mcpo_combo.setStyleSheet("QComboBox { combobox-popup: 0; }")
        conn = self.conn
        try:
            cursor = conn.cursor(cursor_factory = extras.RealDictCursor)
            cursor.execute(f'''select nombre,idmunicipio from datos.municipio where idprovincia = '{idprov}' order by nombre ''')
            datos = cursor.fetchall()
            for row in datos:
                self.mcpo_combo.addItem(row["nombre"], row["idmunicipio"])        
        except errors.lookup('22P02'):
             print('error')
             conn.rollback()
             pass

    def crearAmbientes(self):
        self.tools.crearAmbientes(self)

    def crearSegmentos(self):
        self.tools.crearSegmentos(self)

    def cargarParcela(self):
        self.tools.cargarParcela(self)

    def segmentoDialog(self):
        dialog = agraeSegmentoDialog()
        dialog.exec_() 

    def buscarSegmento(self):

        print('prueba buscar segmento')
        param = self.line_find_segmento.text()
        sql = self.utils.segmentosQueryTable(str(param))
        self.sqlSegmento = sql
        
        try: 
            with self.conn as conn: 
                cursor = conn.cursor() 
                cursor.execute(sql)
                data = cursor.fetchall() 
                # print(data)
                a = len(data)
                b = len(data[0])
                i = 1
                j = 1
                self.tableWidget_2.setRowCount(a)
                self.tableWidget_2.setColumnCount(b)
                for j in range(a):
                    for i in range(b):
                        item = QTableWidgetItem(str(data[j][i]))
                        self.tableWidget_2.setItem(j,i,item)
                
                self.btn_add_layer_2.setEnabled(True)
        
        except Exception as ex:
            print(ex)

    def agregarSegmento(self): 
        param 
            
    def sinceDateChange(self):
        self.sinceDateStatus = True
        d1 = self.sinceDate.date()
        self.untilDate.setMinimumDate(d1)
        self.untilDate.setEnabled(True)

    def buscarLotes(self):
        self.tools.buscarLotes(self, self.sinceDateStatus)
        self.line_buscar.setText('')

    def reloadLotes(self):
        self.tools.buscarLotes(self, False)
        self.btn_reload.setEnabled(False)

    def cargarLote(self):
        self.tools.cargarLote(self)


class loteFilterDialog(QtWidgets.QDialog,agraeLoteParcelaDialog): 

    closingPlugin = pyqtSignal()

    def __init__(self, parent=None):
        """Constructor."""
        super(loteFilterDialog, self).__init__(parent)
        # self.s = QSettings('agrae', 'dbhost')
        # Set up the user interface from Designer.
        # After setupUI you can access any designer object by doing
        # self.<objectname>, and you can use autoconnect slots - see
        # http://doc.qt.io/qt-5/designer-using-a-ui-file.html
        # #widgets-and-dialogs-with-auto-connect
        self.setupUi(self)
        self.utils = AgraeUtils()
        self.tools = AgraeToolset()
        self.conn = self.utils.Conn()
        self.UIcomponents()
        self.sinceDateStatus = False

    def closeEvent(self, event):
        self.closingPlugin.emit()
        event.accept()

    def UIcomponents(self):
        self.lotesCompleter()



        icons_path = self.utils.iconsPath()
        self.sinceDate.dateChanged.connect(self.sinceDateChange)
        self.line_buscar.setClearButtonEnabled(True)
        line_buscar_action = self.line_buscar.addAction(QIcon(icons_path['search_icon_path']), self.line_buscar.TrailingPosition)
        line_buscar_action.triggered.connect(self.buscarLotes)
        self.btn_add_layer.setIcon(QIcon(icons_path['add_layer_to_map']))
        self.btn_add_layer.setIconSize(QtCore.QSize(20, 20))
        self.btn_add_layer.clicked.connect(self.cargarLote)
        
        self.btn_reload.setIcon(QIcon(icons_path['reload_data']))
        self.btn_reload.setIconSize(QtCore.QSize(20, 20))
        self.btn_reload.setToolTip('Buscar todos los lotes')
        self.btn_reload.clicked.connect(self.reloadLotes)

        self.tableWidget.horizontalHeader().setStretchLastSection(True)
        self.tableWidget.setColumnHidden(0, True)
        self.tableWidget.setColumnHidden(4, True)
        self.tableWidget.setColumnHidden(6, True)



        pass
    def sinceDateChange(self):
        self.sinceDateStatus = True
        d1 = self.sinceDate.date()
        self.untilDate.setMinimumDate(d1)
        self.untilDate.setEnabled(True)

    def buscarLotes(self): 
        self.tools.buscarLotes(self,self.sinceDateStatus)
        self.line_buscar.setText('')
        
    def reloadLotes(self): 
        self.tools.buscarLotes(self,False)
        self.btn_reload.setEnabled(False)
        
    def cargarLote(self): 
        self.tools.cargarLote(self)

    def lotesCompleter(self):
        cursor = self.conn.cursor()
        sql = '''select distinct unnest(array[l.nombre, p.nombre, c.nombre]) from lote l
        left join lotecampania lc on lc.idlote = l.idlote
        left join campania ca on ca.idcampania = lc.idcampania 
        left join loteparcela lp on lc.idlotecampania = lp.idlotecampania 
        left join parcela p on lp.idparcela = p.idparcela
        left join cultivo c on c.idcultivo = ca.idcultivo'''
        cursor.execute(sql)
        data = cursor.fetchall()
        listaLotes = [e[0] for e in data]
        # print(listaLotes)
        completerLotes = QCompleter(listaLotes)
        completerLotes.setCaseSensitivity(False)
        self.line_buscar.setCompleter(completerLotes)
